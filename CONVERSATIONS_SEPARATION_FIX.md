# ุฅุตูุงุญ ูุตู ุงููุญุงุฏุซุงุช ุจูู ุงูุนููุงุก ูุงูุณุงุฆููู

## ุงูุชุงุฑูุฎ
9 ููููุจุฑ 2025

## ุงููุดููุฉ

### ุงููุถุน ูุจู ุงูุฅุตูุงุญ:
1. **ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ** ุชุนุฑุถ **ุฌููุน ุงููุญุงุฏุซุงุช** ุจูุง ูููุง ูุญุงุฏุซุงุช ุงูุณุงุฆููู โ
2. **ุตูุญุฉ ุงูุฃุณุทูู** ุชุนุฑุถ ูุญุงุฏุซุงุช ุงูุณุงุฆููู ููุท โ
3. **ุงููุชูุฌุฉ**: ุชุธูุฑ ุงูุฃุณุงุทูุฑ (ุงูุณุงุฆููู) ูู ููุง ุงูุตูุญุชูู

### ุงููุดููุฉ ุงูุฃุณุงุณูุฉ:
- endpoint `/api/v1/chat/conversations` ูุงู ูุฌูุจ **ุฌููุน ุงููุญุงุฏุซุงุช** ุจุฏูู ุชูููุฒ
- ูู ููู ููุงู ููุชุฑุฉ ูุงุณุชุจุนุงุฏ ุงูุณุงุฆููู ูู ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ

---

## ุงูุญู ุงููุทุจู

### ุงูุชุนุฏููุงุช ุนูู ุงููุงุฌูุฉ ุงูุฎูููุฉ (Backend)

#### ุงูููู: `routes/chatRoutes.js`

### ุงูุชุนุฏูู 1: ุงุณุชุจุนุงุฏ ุงูุณุงุฆููู ูู ุงุณุชุนูุงู ุงููุณุชุฎุฏููู

**ูุจู ุงูุชุนุฏูู** (ุงูุณุทุฑ 141):
```javascript
const users = await User.find({ _id: { $in: userIds } })
  .select("name avatar userType isOnline lastSeen").lean();
```

**ุจุนุฏ ุงูุชุนุฏูู**:
```javascript
const users = await User.find({ 
  _id: { $in: userIds },
  userType: { $ne: 'driver' } // Exclude drivers from regular conversations
}).select("name avatar userType isOnline lastSeen").lean();
```

**ุงููุงุฆุฏุฉ**: 
- ูุณุชุจุนุฏ ุฌููุน ุงููุณุชุฎุฏููู ูู ููุน `driver` ูู ุงููุชุงุฆุฌ
- ูุฌูุจ ููุท ุงูุนููุงุก (shipper, carrier, broker)

---

### ุงูุชุนุฏูู 2: ุฅุฒุงูุฉ ููุฏ ุฌูุจ ูุนูููุงุช ุงููุฑูุจุงุช ูุงูุณุงุฆููู

**ูุจู ุงูุชุนุฏูู** (ุงูุณุทูุฑ 147-154):
```javascript
// Fetch Vehicle details (using fleetAccountId)
const vehicles = await Vehicle.find({ 
  fleetAccountId: { $in: vehicleIds },
  lastLogin: { $exists: true, $ne: null },
  isAccountActive: true
}).select("fleetAccountId driverName imageUrls driverUser")
  .populate("driverUser", "_id name avatar isOnline lastSeen").lean();
const vehicleMap = new Map(vehicles.map(vehicle => 
  [vehicle.driverUser?._id?.toString() || vehicle.fleetAccountId, vehicle]
));
```

**ุจุนุฏ ุงูุชุนุฏูู**:
```javascript
// Note: Vehicle/driver details are not fetched here as they belong to fleet conversations endpoint
```

**ุงููุงุฆุฏุฉ**:
- ุชูููู ุงูุงุณุชุนูุงูุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชุญุณูู ุงูุฃุฏุงุก
- ูุถูุญ ุฃูุซุฑ ูู ุงูููุฏ

---

### ุงูุชุนุฏูู 3: ุฅุฒุงูุฉ ููุทู ุฅุถุงูุฉ ุงูุณุงุฆููู ูู ุงููุฑูุจุงุช

**ูุจู ุงูุชุนุฏูู** (ุงูุณุทูุฑ 162-175):
```javascript
if (isValidObjectId(otherParticipantId)) {
  otherParticipant = userMap.get(otherParticipantId.toString());
  
  // If not found in users, check vehicles (for drivers)
  if (!otherParticipant) {
    const vehicle = vehicleMap.get(otherParticipantId.toString());
    if (vehicle && vehicle.driverUser) {
      otherParticipant = {
        _id: vehicle.driverUser._id,
        name: vehicle.driverUser.name || vehicle.driverName,
        avatar: vehicle.driverUser.avatar || vehicle.imageUrls?.[0] || null,
        userType: 'driver',
        isOnline: vehicle.driverUser.isOnline || false,
        lastSeen: vehicle.driverUser.lastSeen || new Date(),
      };
    }
  }
}
```

**ุจุนุฏ ุงูุชุนุฏูู**:
```javascript
if (isValidObjectId(otherParticipantId)) {
  // Only get non-driver users (customers only)
  otherParticipant = userMap.get(otherParticipantId.toString());
  
  // Skip drivers - they should only appear in fleet conversations endpoint
  // Removed vehicle/driver lookup to keep this endpoint for customers only
}
```

**ุงููุงุฆุฏุฉ**:
- ูุง ูุชู ุฅุถุงูุฉ ุงูุณุงุฆููู ุฅูู ูุงุฆูุฉ ุงููุญุงุฏุซุงุช
- ุงูููุฏ ุฃุจุณุท ูุฃูุถุญ
- ูุตู ูุงุถุญ ุจูู ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ ููุญุงุฏุซุงุช ุงูุฃุณุทูู

---

### ุงูุชุนุฏูู 4: ุฅุฒุงูุฉ ุงุณุชูุฑุงุฏ Vehicle ุบูุฑ ุงููุณุชุฎุฏู

**ูุจู ุงูุชุนุฏูู** (ุงูุณุทุฑ 112):
```javascript
const Vehicle = require("../models/Vehicle"); // Import Vehicle model
```

**ุจุนุฏ ุงูุชุนุฏูู**:
```javascript
// Removed - not needed for customer conversations
```

**ุงููุงุฆุฏุฉ**:
- ุชูุธูู ุงูููุฏ ูู ุงูุงุณุชูุฑุงุฏุงุช ุบูุฑ ุงููุณุชุฎุฏูุฉ

---

## ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### Endpoint: `GET /api/v1/chat/conversations`

**ุงูุขู ูุฌูุจ**:
- โ ูุญุงุฏุซุงุช ุงูุนููุงุก ููุท (shipper, carrier, broker)
- โ **ูุง ูุฌูุจ** ูุญุงุฏุซุงุช ุงูุณุงุฆููู (driver)

**ุงูุงุณุชุฎุฏุงู**:
- ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุฑุฆูุณูุฉ (Chat Tab)
- ูุงุฆูุฉ ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ

---

### Endpoint: `GET /api/v1/chat/conversations/fleet`

**ูุฌูุจ**:
- โ ูุญุงุฏุซุงุช ุงูุณุงุฆููู ููุท (driver)
- โ **ูุง ูุฌูุจ** ูุญุงุฏุซุงุช ุงูุนููุงุก

**ุงูุงุณุชุฎุฏุงู**:
- ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุฃุณุทูู (Fleet Tab)
- ูุงุฆูุฉ ูุญุงุฏุซุงุช ุงูุณุงุฆููู

---

## ุงููุฑู ุจูู ุงูู Endpoints

| ุงูููุฒุฉ | `/conversations` | `/conversations/fleet` |
|--------|------------------|------------------------|
| **ูุฌูุจ ุงูุนููุงุก** | โ ูุนู | โ ูุง |
| **ูุฌูุจ ุงูุณุงุฆููู** | โ ูุง | โ ูุนู |
| **ูุณุชุฎุฏู ูู** | ุตูุญุฉ ุงููุญุงุฏุซุงุช | ุตูุญุฉ ุงูุฃุณุทูู |
| **ุฃููุงุน ุงููุณุชุฎุฏููู** | shipper, carrier, broker | driver |

---

## ุฃููุงุน ุงููุณุชุฎุฏููู ูู ุงููุธุงู

### ุงูุนููุงุก (Customers):
1. **`shipper`**: ุดุงุญู
2. **`carrier`**: ูุงูู
3. **`broker`**: ูุณูุท

### ุงูุฃุณุทูู (Fleet):
4. **`driver`**: ุณุงุฆู

---

## ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ

**ุงูุทูุจ**:
```bash
GET /api/v1/chat/conversations
Authorization: Bearer <token>
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
```json
[
  {
    "_id": "conv123",
    "participant": {
      "_id": "user123",
      "name": "ูุญูุฏ ุฃุญูุฏ",
      "avatar": "https://...",
      "userType": "shipper",  // โ ุนููู ููุท
      "isOnline": true,
      "lastSeen": "2025-11-09T..."
    },
    "lastMessage": { ... },
    "unreadCount": 2,
    "lastMessageTime": "2025-11-09T..."
  }
  // ... ูุญุงุฏุซุงุช ุงูุนููุงุก ููุท
]
```

**ุงูุชุญูู**:
- โ ุฌููุน ุงููุญุงุฏุซุงุช ูู ููุน `shipper`, `carrier`, ุฃู `broker`
- โ ูุง ุชูุฌุฏ ูุญุงุฏุซุงุช ูู ููุน `driver`

---

### 2. ุงุฎุชุจุงุฑ ุตูุญุฉ ุงูุฃุณุทูู

**ุงูุทูุจ**:
```bash
GET /api/v1/chat/conversations/fleet
Authorization: Bearer <token>
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
```json
[
  {
    "_id": "conv456",
    "participant": {
      "_id": "driver123",
      "name": "ุฃุญูุฏ ุงูุณุงุฆู",
      "avatar": "https://...",
      "userType": "driver",  // โ ุณุงุฆู ููุท
      "isOnline": false,
      "lastSeen": "2025-11-09T..."
    },
    "lastMessage": { ... },
    "unreadCount": 0,
    "lastMessageTime": "2025-11-09T..."
  }
  // ... ูุญุงุฏุซุงุช ุงูุณุงุฆููู ููุท
]
```

**ุงูุชุญูู**:
- โ ุฌููุน ุงููุญุงุฏุซุงุช ูู ููุน `driver`
- โ ูุง ุชูุฌุฏ ูุญุงุฏุซุงุช ูู ุฃููุงุน ุฃุฎุฑู

---

## ุงูุชุฃุซูุฑ ุนูู ุงูุฃุฏุงุก

### ุงูุชุญุณููุงุช:
1. โ **ุชูููู ุงูุงุณุชุนูุงูุงุช**: ุฅุฒุงูุฉ ุงุณุชุนูุงู `Vehicle.find()` ุบูุฑ ุงูุถุฑูุฑู
2. โ **ุชุตููุฉ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ุงุณุชุฎุฏุงู `{ $ne: 'driver' }` ุจุฏูุงู ูู ุงูุชุตููุฉ ูู JavaScript
3. โ **ุชูููู ุญุฌู ุงูุจูุงูุงุช**: ุนุฏู ุฌูุจ ุจูุงูุงุช ุงูุณุงุฆููู ูุงููุฑูุจุงุช

### ุงููุชูุฌุฉ:
- โก ุงุณุชุฌุงุจุฉ ุฃุณุฑุน
- ๐ ุงุณุชููุงู ุฃูู ููุฐุงูุฑุฉ
- ๐ฏ ุจูุงูุงุช ุฃูุซุฑ ุฏูุฉ

---

## ุงููุงุฌูุฉ ุงูุฃูุงููุฉ

### ูุง ุชุญุชุงุฌ ูุชุนุฏูู! โ

ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุชุณุชุฎุฏู ุจุงููุนู ุงูุฏูุงู ุงูุตุญูุญุฉ:

```typescript
// ูููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ (ุงูุนููุงุก)
const conversations = await fetchConversations();

// ููุญุงุฏุซุงุช ุงูุฃุณุทูู (ุงูุณุงุฆููู)
const fleetConversations = await fetchFleetConversations();
```

**ููุงุญุธุฉ**: 
- ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุณุชุญุตู ุชููุงุฆูุงู ุนูู ุงูุจูุงูุงุช ุงูุตุญูุญุฉ ุจุนุฏ ุชุญุฏูุซ ุงูุฎุงุฏู
- ูุง ุญุงุฌุฉ ูุฃู ุชุนุฏููุงุช ูู ุงูููุฏ ุงูุฃูุงูู

---

## ุงููููุงุช ุงููุนุฏูุฉ

### ุงููุงุฌูุฉ ุงูุฎูููุฉ:
- โ `routes/chatRoutes.js`: ุชุนุฏูู endpoint `/conversations`

### ุงููุงุฌูุฉ ุงูุฃูุงููุฉ:
- โ ูุง ุชุญุชุงุฌ ูุชุนุฏูู

---

## ุฎุทูุงุช ุงููุดุฑ

### 1. ุฑูุน ุงูุชุญุฏูุซุงุช ุฅูู GitHub
```bash
git add routes/chatRoutes.js
git commit -m "Fix: Separate customer and driver conversations"
git push origin main
```

### 2. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู
- ุงูุฎุงุฏู ุนูู Render.com ุณูุนูุฏ ุงูุชุดุบูู ุชููุงุฆูุงู
- ุฃู ูููู ุฅุนุงุฏุฉ ุงูุชุดุบูู ูุฏููุงู ูู ููุญุฉ ุงูุชุญูู

### 3. ุงุฎุชุจุงุฑ ุงูุชุทุจูู
- ุชุณุฌูู ุงูุฏุฎูู
- ูุชุญ ุตูุญุฉ ุงููุญุงุฏุซุงุช โ ูุฌุจ ุฃู ุชุธูุฑ ุงูุนููุงุก ููุท
- ูุชุญ ุตูุญุฉ ุงูุฃุณุทูู โ ูุฌุจ ุฃู ุชุธูุฑ ุงูุณุงุฆููู ููุท

---

## ุงูุฎูุงุตุฉ

### ูุง ุชู ุฅุตูุงุญู:
1. โ ูุตู ูุงูู ุจูู ูุญุงุฏุซุงุช ุงูุนููุงุก ูุงูุณุงุฆููู
2. โ ุฅุฒุงูุฉ ุงูุณุงุฆููู ูู ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ
3. โ ุชุญุณูู ุงูุฃุฏุงุก ุจุฅุฒุงูุฉ ุงูุงุณุชุนูุงูุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ
4. โ ุชูุธูู ุงูููุฏ ูุชูุถูุญ ุงููุณุคูููุงุช

### ุงููุชูุฌุฉ:
- ๐ฏ **ุตูุญุฉ ุงููุญุงุฏุซุงุช**: ุชุนุฑุถ ุงูุนููุงุก ููุท
- ๐ **ุตูุญุฉ ุงูุฃุณุทูู**: ุชุนุฑุถ ุงูุณุงุฆููู ููุท
- โก **ุฃุฏุงุก ุฃูุถู**: ุงุณุชุนูุงูุงุช ุฃูู ูุฃุณุฑุน
- ๐ **ููุฏ ุฃูุธู**: ุฃุณูู ููุตูุงูุฉ ูุงูุชุทููุฑ

---

**ุงูุญุงูุฉ**: โ ุฌุงูุฒ ูููุดุฑ
**ุงูุชุงุฑูุฎ**: 9 ููููุจุฑ 2025
**ุงููุฑุงุฌุนุฉ**: ุดุงููุฉ ููุงููุฉ
