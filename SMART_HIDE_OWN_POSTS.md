# ميزة الإخفاء الذكي للمنشورات الخاصة (Facebook-Style)

## الوصف

تم تطبيق ميزة **الإخفاء الذكي** في الخادم، تعمل بنفس طريقة فيسبوك:

- ✅ **عند النشر:** المنشور يظهر في صفحتك الرئيسية مؤقتاً
- ✅ **أول 5 دقائق:** المنشور يبقى ظاهر في صفحتك
- ✅ **بعد 5 دقائق:** المنشور يختفي تلقائياً من صفحتك الرئيسية
- ✅ **للمستخدمين الآخرين:** يظهر بشكل طبيعي (حسب نظام الـ 15%)

---

## الفائدة

### لماذا هذه الميزة؟

1. **تأكيد النشر:** عند النشر، ترى المنشور فوراً للتأكد من نجاح العملية
2. **التعديل السريع:** إذا أردت تعديل أو حذف المنشور، تراه مباشرة
3. **تجربة نظيفة:** بعد 5 دقائق، يختفي تلقائياً لتركز على محتوى الآخرين
4. **مثل فيسبوك:** نفس السلوك الذي يتوقعه المستخدمون

---

## التطبيق التقني

### الآلية:

عند جلب المنشورات للصفحة الرئيسية، يتم حساب **عمر المنشور**:

```javascript
const postAge = Date.now() - new Date(post.createdAt).getTime();
const fiveMinutes = 5 * 60 * 1000; // 5 دقائق بالملي ثانية

if (postAge > fiveMinutes) {
  continue; // لا تعرض إذا مر أكثر من 5 دقائق
}
// إذا كان أحدث من 5 دقائق، يعرض
```

---

## الملفات المعدلة

### 1. `routes/postRoutes.js` (السطر 104-114)

```javascript
for (const post of allPosts) {
  // إخفاء منشورات المستخدم الخاصة من صفحته الرئيسية (إلا إذا كان حديث جداً)
  if (post.user._id.toString() === req.user.id) {
    // المنشورات الحديثة جداً (آخر 5 دقائق) تظهر مؤقتاً
    const postAge = Date.now() - new Date(post.createdAt).getTime();
    const fiveMinutes = 5 * 60 * 1000; // 5 دقائق بالملي ثانية
    
    if (postAge > fiveMinutes) {
      continue; // لا تعرض إذا مر أكثر من 5 دقائق
    }
    // إذا كان أحدث من 5 دقائق، يعرض ويكمل للفلترة
  }
  // ... باقي الفلترة
}
```

### 2. `routes/shipmentAdRoutes.js` (السطر 100-109)

```javascript
for (const ad of shipmentAds) {
  // إخفاء إعلانات المستخدم الخاصة من صفحته الرئيسية (إلا إذا كان حديث جداً)
  if (ad.user._id.toString() === req.user.id) {
    // الإعلانات الحديثة جداً (آخر 5 دقائق) تظهر مؤقتاً
    const adAge = Date.now() - new Date(ad.createdAt).getTime();
    const fiveMinutes = 5 * 60 * 1000;
    
    if (adAge > fiveMinutes) {
      continue; // لا تعرض إذا مر أكثر من 5 دقائق
    }
  }
  // ... باقي الفلترة
}
```

### 3. `routes/emptyTruckAdRoutes.js` (السطر 86-95)

```javascript
for (const ad of emptyTruckAds) {
  // إخفاء إعلانات المستخدم الخاصة من صفحته الرئيسية (إلا إذا كان حديث جداً)
  if (ad.user._id.toString() === req.user.id) {
    // الإعلانات الحديثة جداً (آخر 5 دقائق) تظهر مؤقتاً
    const adAge = Date.now() - new Date(ad.createdAt).getTime();
    const fiveMinutes = 5 * 60 * 1000;
    
    if (adAge > fiveMinutes) {
      continue; // لا تعرض إذا مر أكثر من 5 دقائق
    }
  }
  // ... باقي الفلترة
}
```

---

## آلية العمل الكاملة

### 🔹 السيناريو 1: نشر منشور جديد

```
الوقت: 12:00:00
المستخدم A ينشر منشوراً
         ↓
الوقت: 12:00:05
المستخدم A يفتح الصفحة الرئيسية
         ↓
الباك إند يحسب عمر المنشور: 5 ثواني
         ↓
5 ثواني < 5 دقائق ✅
         ↓
المنشور يظهر في الصفحة الرئيسية ✅
```

### 🔹 السيناريو 2: بعد 3 دقائق

```
الوقت: 12:03:00
المستخدم A يفتح الصفحة الرئيسية
         ↓
الباك إند يحسب عمر المنشور: 3 دقائق
         ↓
3 دقائق < 5 دقائق ✅
         ↓
المنشور يظهر في الصفحة الرئيسية ✅
```

### 🔹 السيناريو 3: بعد 6 دقائق

```
الوقت: 12:06:00
المستخدم A يفتح الصفحة الرئيسية
         ↓
الباك إند يحسب عمر المنشور: 6 دقائق
         ↓
6 دقائق > 5 دقائق ❌
         ↓
المنشور لا يظهر في الصفحة الرئيسية ❌
```

### 🔹 السيناريو 4: للمستخدمين الآخرين

```
الوقت: أي وقت
المستخدم B يفتح الصفحة الرئيسية
         ↓
المنشور ليس من تأليف B
         ↓
يطبق نظام الفلترة العادي (15% للمتابعين)
         ↓
المنشور يظهر بشكل طبيعي ✅
```

---

## المزايا

### ✅ بسيط وفعال:
- لا يحتاج جداول إضافية في قاعدة البيانات
- لا يحتاج cron jobs أو scheduled tasks
- يعتمد فقط على حقل `createdAt` الموجود أصلاً

### ✅ دقيق:
- يحسب الوقت بالملي ثانية
- يعمل في أي timezone
- لا يتأثر بتوقيت الخادم أو العميل

### ✅ قابل للتخصيص:
- يمكن تغيير المدة من 5 دقائق إلى أي مدة أخرى
- يمكن جعلها متغيرة حسب نوع المحتوى

---

## التخصيص

### تغيير المدة:

إذا أردت تغيير المدة من 5 دقائق إلى مدة أخرى:

```javascript
// 10 دقائق
const tenMinutes = 10 * 60 * 1000;

// 30 ثانية
const thirtySeconds = 30 * 1000;

// ساعة واحدة
const oneHour = 60 * 60 * 1000;
```

### مدة مختلفة لكل نوع:

```javascript
// في postRoutes.js
const postDuration = 5 * 60 * 1000; // 5 دقائق للمنشورات

// في shipmentAdRoutes.js
const adDuration = 10 * 60 * 1000; // 10 دقائق للإعلانات
```

---

## الاختبار

### خطوات الاختبار:

1. **انشر منشور جديد**
2. **افتح الصفحة الرئيسية فوراً**
3. **النتيجة:** المنشور يظهر ✅
4. **انتظر 6 دقائق**
5. **افتح الصفحة الرئيسية مرة أخرى**
6. **النتيجة:** المنشور لا يظهر ✅
7. **افتح الملف الشخصي**
8. **النتيجة:** المنشور يظهر ✅

### اختبار متقدم:

```bash
# في terminal، احسب عمر منشور:
node -e "console.log((Date.now() - new Date('2025-10-31T08:00:00Z').getTime()) / 1000 / 60, 'minutes')"
```

---

## التوافق

هذه الميزة تعمل بالتوازي مع:
- ✅ نظام الفلترة 15% للمتابعين
- ✅ نظام الإشعارات
- ✅ خوارزمية الترتيب Facebook-style
- ✅ جميع أنواع المحتوى (منشورات، إعلانات)

---

## الأداء

### تأثير على الأداء:

- **ضئيل جداً**: عملية حسابية بسيطة (طرح وقتين)
- **لا يتطلب استعلامات إضافية** من قاعدة البيانات
- **يعمل في الذاكرة** (in-memory calculation)

### مقارنة:

| الطريقة | استعلامات DB | تعقيد الوقت | الدقة |
|---------|--------------|------------|-------|
| الحل الحالي | 0 إضافية | O(1) | دقيقة جداً |
| Cron job | 1+ | O(n) | تقريبية |
| Session storage | 0 | O(1) | تعتمد على العميل |

---

## الملاحظات

### ⚠️ مهم:

1. **الوقت يعتمد على `createdAt`** - تأكد أن قاعدة البيانات تحفظ الوقت بشكل صحيح
2. **لا يحتاج تعديل في الواجهة الأمامية** - كل شيء في الباك إند
3. **يعمل فوراً** بعد رفع التحديثات وإعادة تشغيل الخادم

### 💡 نصيحة:

إذا أردت اختبار الميزة بسرعة، غيّر المدة مؤقتاً إلى 30 ثانية:

```javascript
const fiveMinutes = 30 * 1000; // 30 ثانية للاختبار
```

---

## التاريخ

**2025-10-31**: تطبيق ميزة الإخفاء الذكي للمنشورات الخاصة (Facebook-Style)
