# جدولة الذكاء الاصطناعي التلقائية - AI Scheduler

## نظرة عامة

تم إضافة نظام جدولة تلقائي لتشغيل ميزات الذكاء الاصطناعي بشكل يومي دون الحاجة للتشغيل اليدوي.

---

## ⏰ الجدول الزمني

### الوقت الافتراضي:
**كل يوم الساعة 9:00 صباحاً** (بتوقيت السعودية - GMT+3)

### ماذا يحدث تلقائياً؟
1. النظام يبحث عن جميع الشركات التي لديها ميزات AI مفعلة
2. يشغل الميزات المفعلة لكل شركة:
   - ✅ النشر التلقائي للشاحنات الفارغة
   - ✅ المراسلة التلقائية للعملاء المحتملين
   - ✅ الترويج للأسطول (مع صور الأسطول والشاحنات)
   - ✅ التقارير الأسبوعية
3. يسجل النتائج في console logs

---

## 🚀 التشغيل

### التشغيل التلقائي:
الجدولة تبدأ تلقائياً عند تشغيل الخادم:
```bash
npm start
```

ستظهر رسالة:
```
⏰ AI Scheduler initialized - Will run daily at 9:00 AM (Saudi Arabia time)
```

### التحقق من عمل الجدولة:
راقب console logs كل يوم الساعة 9 صباحاً، ستظهر:
```
🤖 [AI Scheduler] Starting daily AI features execution at [التاريخ والوقت]
🏢 Found X companies with AI features enabled
▶️  Running AI features for: [اسم الشركة]
   ✅ Auto Posting: تم إنشاء 3 منشورات بنجاح
   ✅ Fleet Promotion: تم إنشاء منشور ترويجي بنجاح
✅ [AI Scheduler] Completed: X successful, 0 errors
```

---

## 🔧 تخصيص الوقت

### لتغيير وقت التشغيل:

افتح ملف `utils/aiScheduler.js` وعدّل السطر:

```javascript
// الوقت الحالي: كل يوم الساعة 9:00 صباحاً
cron.schedule('0 0 9 * * *', async () => {
```

### أمثلة على أوقات مختلفة:

```javascript
// كل يوم الساعة 6:00 صباحاً
cron.schedule('0 0 6 * * *', async () => {

// كل يوم الساعة 12:00 ظهراً
cron.schedule('0 0 12 * * *', async () => {

// كل يوم الساعة 6:00 مساءً
cron.schedule('0 0 18 * * *', async () => {

// مرتين يومياً: 9 صباحاً و 6 مساءً
cron.schedule('0 0 9,18 * * *', async () => {

// كل 6 ساعات
cron.schedule('0 0 */6 * * *', async () => {

// كل يوم أحد الساعة 9 صباحاً فقط
cron.schedule('0 0 9 * * 0', async () => {

// من الإثنين إلى الجمعة الساعة 9 صباحاً
cron.schedule('0 0 9 * * 1-5', async () => {
```

### شرح صيغة Cron:
```
* * * * * *
│ │ │ │ │ │
│ │ │ │ │ └─── يوم الأسبوع (0-6) (0 = الأحد)
│ │ │ │ └───── الشهر (1-12)
│ │ │ └─────── اليوم من الشهر (1-31)
│ │ └───────── الساعة (0-23)
│ └─────────── الدقيقة (0-59)
└───────────── الثانية (0-59)
```

---

## 📊 التحسينات المضافة

### 1. نشر صور الأسطول تلقائياً ✅

عند تشغيل ميزة "الترويج للأسطول"، النظام الآن:
- ✅ يجمع صور الأسطول من ملف الشركة (`fleetImages`)
- ✅ يضيف صور الشاحنات الفردية من قاعدة البيانات
- ✅ يختار حتى 5 صور لكل منشور
- ✅ ينشر المنشور مع النص الترويجي + الصور

### 2. سجلات مفصلة (Detailed Logs)

كل عملية تسجل:
- عدد الشركات المستهدفة
- نتيجة كل ميزة لكل شركة
- عدد المنشورات/الرسائل المُنشأة
- الأخطاء إن وجدت

---

## 🛠️ استكشاف الأخطاء

### المشكلة: الجدولة لا تعمل

**الحل:**
1. تأكد من تثبيت `node-cron`:
   ```bash
   npm install node-cron
   ```
2. أعد تشغيل الخادم:
   ```bash
   npm restart
   ```
3. تحقق من console logs عند بدء التشغيل

### المشكلة: لا يتم النشر رغم الجدولة

**الحل:**
1. تأكد من تفعيل الميزات في إعدادات الشركة
2. تحقق من وجود `DEEPSEEK_API_KEY` في `.env`
3. تحقق من وجود بيانات الأسطول (شاحنات، صور)
4. راجع console logs للأخطاء

### المشكلة: الوقت غير صحيح

**الحل:**
تأكد من ضبط المنطقة الزمنية في الكود:
```javascript
{
  timezone: "Asia/Riyadh" // Saudi Arabia timezone
}
```

---

## 📁 الملفات المضافة/المعدلة

### ملفات جديدة:
- ✅ `utils/aiScheduler.js` - نظام الجدولة التلقائية
- ✅ `AI_SCHEDULER_README.md` - هذا الملف

### ملفات معدلة:
- ✅ `server.js` - إضافة استدعاء الجدولة عند بدء الخادم
- ✅ `utils/aiService.js` - تحسين نشر صور الأسطول
- ✅ `package.json` - إضافة حزمة `node-cron`

---

## 🎯 الميزات الإضافية

### تشغيل يدوي فوري (للاختبار):

إذا أردت تشغيل الميزات فوراً دون انتظار الجدولة:

1. افتح `utils/aiScheduler.js`
2. استخدم الدالة `runAIFeaturesNow()`
3. أو استخدم endpoint الموجود: `POST /api/v1/ai-features/run`

---

## 📊 الإحصائيات والمراقبة

### ما يتم تسجيله:
- ✅ وقت بدء التشغيل
- ✅ عدد الشركات المستهدفة
- ✅ نتائج كل ميزة
- ✅ عدد المنشورات/الرسائل المُنشأة
- ✅ الأخطاء والمشاكل
- ✅ وقت الانتهاء

### مثال على السجل:
```
🤖 [AI Scheduler] Starting daily AI features execution at 27/10/2025, 9:00:00 AM
🏢 Found 5 companies with AI features enabled
▶️  Running AI features for: شركة النقل السريع (507f1f77bcf86cd799439011)
   ✅ Auto Posting: تم إنشاء 2 منشورات بنجاح
   ✅ Fleet Promotion: تم إنشاء منشور ترويجي بنجاح
▶️  Running AI features for: شركة الشحن الدولي (507f1f77bcf86cd799439012)
   ✅ Auto Messaging: تم إرسال 3 رسائل بنجاح
✅ [AI Scheduler] Completed: 5 successful, 0 errors
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 💰 التكلفة والتحكم

### تقليل التكلفة:
1. فعّل الميزات التي تحتاجها فقط
2. قلل عدد مرات التشغيل اليومي
3. راقب استهلاك DeepSeek API

### إيقاف الجدولة مؤقتاً:
علّق السطر في `server.js`:
```javascript
// startAIScheduler(); // معطل مؤقتاً
```

---

## 🔐 الأمان

- ✅ الجدولة تعمل فقط للشركات المفعلة
- ✅ كل شركة ترى منشوراتها ورسائلها فقط
- ✅ مفتاح DeepSeek API محمي في متغيرات البيئة
- ✅ السجلات لا تحتوي على بيانات حساسة

---

## 📞 الدعم

للمساعدة أو الإبلاغ عن مشاكل:
- راجع console logs للأخطاء
- تحقق من إعدادات الشركة
- تأكد من صحة مفتاح DeepSeek API

---

**تم التطوير بنجاح! 🚀**

الآن لديك نظام ذكاء اصطناعي كامل يعمل تلقائياً كل يوم!

