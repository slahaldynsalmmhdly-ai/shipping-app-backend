# ุชุญููู ูุดููุฉ ุนุฏู ุงููุตู ุจูู ูุญุงุฏุซุงุช ุงูุนููุงุก ูุงูุณุงุฆููู

## ุงููุดููุฉ ุงูุญุงููุฉ ๐ด

### ุงููุถุน ุงูุญุงูู:
1. **ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ** (`/conversations`): ุชุนุฑุถ **ุฌููุน ุงููุญุงุฏุซุงุช** ุจูุง ูููุง ูุญุงุฏุซุงุช ุงูุณุงุฆููู
2. **ุตูุญุฉ ุงูุฃุณุทูู** (`/conversations/fleet`): ุชุนุฑุถ **ูุญุงุฏุซุงุช ุงูุณุงุฆููู ููุท**

### ุงููุดููุฉ:
- ูู ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ (ููุนููุงุก) ุชุธูุฑ ููุงุฆู ุงูุฃุณุงุทูุฑ (ุงูุณุงุฆููู) โ
- ูุฌุจ ุฃู ุชุธูุฑ ูุญุงุฏุซุงุช ุงูุณุงุฆููู **ููุท** ูู ุตูุญุฉ ุงูุฃุณุทูู
- ูุฌุจ ุฃู ุชุธูุฑ ูุญุงุฏุซุงุช ุงูุนููุงุก **ููุท** ูู ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ

---

## ุงูุณุจุจ ุงูุฌุฐุฑู ๐

### ูู ุงููุงุฌูุฉ ุงูุฎูููุฉ (Backend):

#### Endpoint: `GET /api/v1/chat/conversations`

ุงูููุฏ ุงูุญุงูู ูู ุงูุณุทุฑ **110-228** ูู `chatRoutes.js`:

```javascript
router.get("/conversations", protectUnified, async (req, res) => {
  // ... ูุฌูุจ ุฌููุน ุงููุญุงุฏุซุงุช
  const conversations = await Conversation.find({
    participants: req.user.id,
  })
  
  // ... ูุฌูุจ ูุนูููุงุช ุฌููุน ุงููุณุชุฎุฏููู (ุจูุง ูููู ุงูุณุงุฆููู)
  const users = await User.find({ _id: { $in: userIds } })
    .select("name avatar userType isOnline lastSeen").lean();
  
  // ... ูุชุญูู ูู ุงูุณุงุฆููู ููุถูููู
  if (!otherParticipant) {
    const vehicle = vehicleMap.get(otherParticipantId.toString());
    if (vehicle && vehicle.driverUser) {
      otherParticipant = {
        _id: vehicle.driverUser._id,
        name: vehicle.driverUser.name || vehicle.driverName,
        avatar: vehicle.driverUser.avatar || vehicle.imageUrls?.[0] || null,
        userType: 'driver', // โ ููุง ุงููุดููุฉ! ูุถูู ุงูุณุงุฆููู
        // ...
      };
    }
  }
  
  // ... ูุฑุฌุน ุฌููุน ุงููุญุงุฏุซุงุช ุจุฏูู ุชุตููุฉ
  res.json(formattedConversations);
});
```

**ุงููุดููุฉ**: 
- ูุง ููุฌุฏ **ุชุตููุฉ** ูุงุณุชุจุนุงุฏ ุงูุณุงุฆููู ูู endpoint ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ
- ูุชู ุฅุฑุฌุงุน **ุฌููุน ุงููุญุงุฏุซุงุช** ุจูุง ูููุง ูุญุงุฏุซุงุช ุงูุณุงุฆููู

---

## ุงูุญู ุงููุทููุจ โ

### ูุฌุจ ุชุนุฏูู endpoint ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ ููุณุชุจุนุฏ ุงูุณุงุฆููู:

```javascript
router.get("/conversations", protectUnified, async (req, res) => {
  // ... ููุณ ุงูููุฏ ุงูุญุงูู ุญุชู ุงูุณุทุฑ 141
  
  // Fetch User details - ุงุณุชุจุนุงุฏ ุงูุณุงุฆููู
  const users = await User.find({ 
    _id: { $in: userIds },
    userType: { $ne: 'driver' } // โ ุฅุถุงูุฉ ูุฐุง ุงูุดุฑุท ูุงุณุชุจุนุงุฏ ุงูุณุงุฆููู
  }).select("name avatar userType isOnline lastSeen").lean();
  
  // ... ุจุงูู ุงูููุฏ
  
  // Format conversations - ุงุณุชุจุนุงุฏ ูุญุงุฏุซุงุช ุงูุณุงุฆููู
  const formattedConversations = conversations.map((conv) => {
    // ... ููุณ ุงูููุฏ
    
    // ุงุณุชุจุนุงุฏ ุงูุณุงุฆููู ูู ุงููุชุงุฆุฌ
    if (otherParticipant && otherParticipant.userType === 'driver') {
      return null; // โ ุชุฌุงูู ูุญุงุฏุซุงุช ุงูุณุงุฆููู
    }
    
    // ... ุจุงูู ุงูููุฏ
  }).filter(conv => conv !== null);
  
  res.json(formattedConversations);
});
```

---

## ุงูุชุนุฏููุงุช ุงููุทููุจุฉ ๐

### 1. ุชุนุฏูู ุงููุงุฌูุฉ ุงูุฎูููุฉ (Backend)

#### ุงูููู: `routes/chatRoutes.js`

**ุงูุชุนุฏูู 1**: ูู ุงูุณุทุฑ **141**ุ ุชุนุฏูู ุงุณุชุนูุงู ุฌูุจ ุงููุณุชุฎุฏููู:

```javascript
// ูุจู ุงูุชุนุฏูู:
const users = await User.find({ _id: { $in: userIds } })
  .select("name avatar userType isOnline lastSeen").lean();

// ุจุนุฏ ุงูุชุนุฏูู:
const users = await User.find({ 
  _id: { $in: userIds },
  userType: { $ne: 'driver' } // ุงุณุชุจุนุงุฏ ุงูุณุงุฆููู
}).select("name avatar userType isOnline lastSeen").lean();
```

**ุงูุชุนุฏูู 2**: ูู ุงูุณุทุฑ **154-205**ุ ุฅุถุงูุฉ ูุญุต ูุงุณุชุจุนุงุฏ ุงูุณุงุฆููู:

```javascript
// Format conversations for frontend
const formattedConversations = conversations.map((conv) => {
  const otherParticipantId = conv.participants.find(p => p.toString() !== req.user.id);
  let otherParticipant = null;

  if (isValidObjectId(otherParticipantId)) {
    // Try to find in User map first
    otherParticipant = userMap.get(otherParticipantId.toString());
    
    // ุงุณุชุจุนุงุฏ ุงูุณุงุฆููู - ุฅุฒุงูุฉ ุงูููุฏ ุงูุฐู ูุถูู ุงูุณุงุฆููู ูู ุงููุฑูุจุงุช
    // ุญุฐู ุงูุณุทูุฑ 162-175 (ุงูููุฏ ุงูุฐู ูุชุญูู ูู vehicles)
  }

  // Skip conversation if participant details could not be found
  if (!otherParticipant) {
    return null;
  }
  
  // ุงุณุชุจุนุงุฏ ุงูุณุงุฆููู ูู ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ
  if (otherParticipant.userType === 'driver') {
    return null;
  }

  return {
    // ... ุจุงูู ุงูููุฏ
  };
}).filter(conv => conv !== null);
```

---

## ุงููุฑู ุจูู ุงูู Endpoints ุจุนุฏ ุงูุชุนุฏูู ๐

### `GET /api/v1/chat/conversations` (ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ)
- โ ูุฌูุจ ูุญุงุฏุซุงุช **ุงูุนููุงุก ููุท** (shipper, carrier, broker)
- โ **ูุง ูุฌูุจ** ูุญุงุฏุซุงุช ุงูุณุงุฆููู (driver)
- ๐ฏ ูุณุชุฎุฏู ูู ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุฑุฆูุณูุฉ

### `GET /api/v1/chat/conversations/fleet` (ูุญุงุฏุซุงุช ุงูุฃุณุทูู)
- โ ูุฌูุจ ูุญุงุฏุซุงุช **ุงูุณุงุฆููู ููุท** (driver)
- โ **ูุง ูุฌูุจ** ูุญุงุฏุซุงุช ุงูุนููุงุก
- ๐ฏ ูุณุชุฎุฏู ูู ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุฃุณุทูู

---

## ุฃููุงุน ุงููุณุชุฎุฏููู ูู ุงููุธุงู ๐ฅ

ุญุณุจ ุงูููุฏุ ุฃููุงุน ุงููุณุชุฎุฏููู ูู:

1. **`shipper`**: ุดุงุญู (ุนููู)
2. **`carrier`**: ูุงูู (ุนููู)
3. **`broker`**: ูุณูุท (ุนููู)
4. **`driver`**: ุณุงุฆู (ุฃุณุทูู)

### ุงูุชุตููู:
- **ุนููุงุก**: shipper, carrier, broker โ ูุธูุฑูู ูู `/conversations`
- **ุณุงุฆููู**: driver โ ูุธูุฑูู ูู `/conversations/fleet`

---

## ุงูุงุฎุชุจุงุฑ ๐งช

ุจุนุฏ ุชุทุจูู ุงูุชุนุฏููุงุช:

### 1. ุงุฎุชุจุงุฑ ุตูุญุฉ ุงููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ:
```bash
GET /api/v1/chat/conversations
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ**: 
- โ ุชุธูุฑ ูุญุงุฏุซุงุช ุงูุนููุงุก ููุท (shipper, carrier, broker)
- โ ูุง ุชุธูุฑ ูุญุงุฏุซุงุช ุงูุณุงุฆููู (driver)

### 2. ุงุฎุชุจุงุฑ ุตูุญุฉ ุงูุฃุณุทูู:
```bash
GET /api/v1/chat/conversations/fleet
```
**ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
- โ ุชุธูุฑ ูุญุงุฏุซุงุช ุงูุณุงุฆููู ููุท (driver)
- โ ูุง ุชุธูุฑ ูุญุงุฏุซุงุช ุงูุนููุงุก

---

## ููุฎุต ุงูุชุนุฏููุงุช ๐

### ุงููุงุฌูุฉ ุงูุฎูููุฉ:
1. โ ุชุนุฏูู ุงุณุชุนูุงู `User.find()` ูุงุณุชุจุนุงุฏ ุงูุณุงุฆููู
2. โ ุฅุฒุงูุฉ ุงูููุฏ ุงูุฐู ูุถูู ุงูุณุงุฆููู ูู ุงููุฑูุจุงุช
3. โ ุฅุถุงูุฉ ูุญุต ููุงุฆู ูุงุณุชุจุนุงุฏ ุงูุณุงุฆููู ูู ุงููุชุงุฆุฌ

### ุงููุงุฌูุฉ ุงูุฃูุงููุฉ:
- โ ูุง ุชุญุชุงุฌ ูุชุนุฏูู (ุชุณุชุฎุฏู ููุณ ุงูุฏูุงู ุงูููุฌูุฏุฉ)
- โ `fetchConversations()` โ ูุญุงุฏุซุงุช ุงูุนููุงุก
- โ `fetchFleetConversations()` โ ูุญุงุฏุซุงุช ุงูุณุงุฆููู

---

## ุงูุญุงูุฉ ๐

- โณ **ูู ุงูุชุธุงุฑ ุงูุชุทุจูู**: ุงูุชุนุฏููุงุช ุฌุงูุฒุฉ ููุชุทุจูู ุนูู ุงููุงุฌูุฉ ุงูุฎูููุฉ
- ๐ **ุงูููุฏ ุงููุงูู**: ุณูุชู ุชูููุฑู ูู ููู ูููุตู
