# توثيق تحديث نظام الـ Feed

## التاريخ
31 أكتوبر 2025

## الملخص
تم تطوير نظام جديد لعرض المنشورات في الصفحة الرئيسية بنظام مشابه لفيسبوك، حيث يتم دمج المنشورات والإعلانات مع تطبيق خوارزمية ذكية لعرض نسبة قليلة من منشورات المتابَعين (15%) مع منشورات متنوعة من مستخدمين آخرين (85%).

## المشاكل التي تم حلها

### 1. مشكلة الارتباك في الواجهة الأمامية
**المشكلة**: عند استخدام الخلط العشوائي، كانت المنشورات تظهر ثم تختفي ثم تظهر منشورات جديدة عند كل تحديث.

**الحل**: استخدام خوارزمية خلط ثابتة (seeded random) بناءً على معرف المستخدم، مما يضمن نفس الترتيب عند كل تحديث للصفحة.

### 2. مشكلة ظهور جميع منشورات المتابَعين
**المشكلة**: عند الترتيب حسب التاريخ فقط، كانت جميع منشورات المتابَعين تظهر في الصفحة الرئيسية.

**الحل**: تطبيق نسبة 15% فقط لمنشورات المتابَعين مع 85% لمنشورات المستخدمين الآخرين.

### 3. عدم دمج الإعلانات
**المشكلة**: كانت المنشورات فقط تظهر في الصفحة الرئيسية، بدون إعلانات الشحن أو الشاحنات الفارغة.

**الحل**: إنشاء endpoint جديد `/api/v1/feed` يدمج:
- المنشورات (Posts)
- إعلانات الشحن (ShipmentAds)
- إعلانات الشاحنات الفارغة (EmptyTruckAds)

## الملفات المضافة

### 1. `/routes/feedRoutes.js`
ملف جديد يحتوي على:
- **Endpoint**: `GET /api/v1/feed`
  - يدمج جميع أنواع المحتوى
  - يطبق خوارزمية التسجيل والترتيب
  - يدعم pagination
  - يستخدم خلط ثابت لتجنب الارتباك

- **Endpoint**: `GET /api/v1/feed/stats`
  - يعرض إحصائيات الـ feed (للتطوير والاختبار)

### 2. خوارزمية التسجيل (Scoring Algorithm)

#### أ. حساب نقاط التفاعل
```javascript
engagementScore = (reactions × 2) + (comments × 3)
```

#### ب. حساب نقاط الوقت
- المنشورات الأحدث من 24 ساعة: 100-52 نقطة
- من 24-72 ساعة: 50-26 نقطة
- من 72-168 ساعة (أسبوع): 25-15 نقطة
- أكثر من أسبوع: 15-1 نقطة

#### ج. النقاط النهائية
```javascript
finalScore = (timeScore × 0.3) + (engagementScore × 0.4) + (relationshipScore × 0.3)
```

حيث:
- `timeScore`: نقاط الوقت (30%)
- `engagementScore`: نقاط التفاعل (40%)
- `relationshipScore`: 30 نقطة إذا كان من المتابَعين، 0 إذا لم يكن (30%)

### 3. خوارزمية الخلط الثابت (Seeded Shuffle)

تستخدم معرف المستخدم كـ seed لتوليد نفس الترتيب في كل مرة:

```javascript
function seededShuffle(array, seed) {
  // يستخدم خوارزمية Linear Congruential Generator
  random = (random * 9301 + 49297) % 233280
}
```

**الفائدة**: 
- نفس المستخدم يرى نفس الترتيب عند التحديث
- مستخدمين مختلفين يرون ترتيبات مختلفة
- لا يوجد ارتباك في الواجهة الأمامية

## التعديلات على الملفات الموجودة

### `/server.js`
تم إضافة:
```javascript
const feedRoutes = require("./routes/feedRoutes");
app.use("/api/v1/feed", feedRoutes);
```

## كيفية الاستخدام

### للواجهة الأمامية (Frontend)

#### 1. جلب الـ Feed الموحد
```javascript
// بدلاً من استدعاء /api/v1/posts
// استخدم الـ endpoint الجديد:

fetch('/api/v1/feed?page=1&limit=20', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(data => {
  console.log(data.items); // المنشورات والإعلانات المدمجة
  console.log(data.pagination); // معلومات الصفحات
});
```

#### 2. التعامل مع أنواع المحتوى المختلفة
كل عنصر في `data.items` يحتوي على حقل `itemType`:

```javascript
data.items.forEach(item => {
  switch(item.itemType) {
    case 'post':
      // عرض منشور عادي
      renderPost(item);
      break;
    case 'shipmentAd':
      // عرض إعلان شحن
      renderShipmentAd(item);
      break;
    case 'emptyTruckAd':
      // عرض إعلان شاحنة فارغة
      renderEmptyTruckAd(item);
      break;
  }
});
```

#### 3. Pagination (التمرير اللانهائي)
```javascript
let currentPage = 1;

function loadMoreItems() {
  currentPage++;
  fetch(`/api/v1/feed?page=${currentPage}&limit=20`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.pagination.hasMore) {
      appendItems(data.items);
    } else {
      // لا يوجد المزيد من العناصر
      showEndMessage();
    }
  });
}
```

#### 4. جلب الإحصائيات (اختياري)
```javascript
fetch('/api/v1/feed/stats', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(stats => {
  console.log('Total Posts:', stats.totalPosts);
  console.log('Total Shipment Ads:', stats.totalShipmentAds);
  console.log('Total Empty Truck Ads:', stats.totalEmptyTruckAds);
  console.log('Following Count:', stats.followingCount);
});
```

## الـ Endpoints القديمة

### ملاحظة مهمة
الـ endpoints القديمة ما زالت تعمل ولم يتم حذفها:
- `GET /api/v1/posts` - لعرض المنشورات فقط
- `GET /api/v1/shipmentads` - لعرض إعلانات الشحن فقط
- `GET /api/v1/emptytruckads` - لعرض إعلانات الشاحنات الفارغة فقط

**لكن يُنصح بشدة** باستخدام الـ endpoint الجديد `/api/v1/feed` للصفحة الرئيسية.

## المزايا الجديدة

### 1. تجربة مستخدم محسّنة
- لا يوجد ارتباك عند التحديث
- محتوى متنوع من مصادر مختلفة
- توازن بين المتابَعين وغير المتابَعين

### 2. خوارزمية ذكية
- تعطي الأولوية للمحتوى الحديث
- تأخذ في الاعتبار التفاعلات
- تعزز منشورات المتابَعين بشكل معتدل

### 3. أداء محسّن
- استخدام `.lean()` لتحسين الأداء
- Pagination فعال
- حد أقصى 100 عنصر في الذاكرة

### 4. قابلية التوسع
- سهولة إضافة أنواع محتوى جديدة
- إمكانية تعديل النسب والأوزان
- دعم للإحصائيات والتحليلات

## الخطوات التالية (اختياري)

### تحسينات مستقبلية محتملة:
1. إضافة فلترة حسب الموقع الجغرافي
2. إضافة تفضيلات المستخدم (أنواع المحتوى المفضلة)
3. تحسين خوارزمية التسجيل بناءً على سلوك المستخدم
4. إضافة cache للنتائج لتحسين الأداء
5. إضافة A/B testing لاختبار نسب مختلفة

## الاختبار

### اختبار يدوي:
1. تسجيل الدخول كمستخدم
2. استدعاء `/api/v1/feed`
3. التحقق من:
   - وجود محتوى متنوع (منشورات + إعلانات)
   - نسبة المتابَعين حوالي 15%
   - نفس الترتيب عند التحديث
   - عمل pagination بشكل صحيح

### اختبار الإحصائيات:
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:5000/api/v1/feed/stats
```

## الدعم والمساعدة

إذا واجهت أي مشاكل:
1. تحقق من أن الـ token صحيح
2. تحقق من أن المستخدم لديه متابَعين
3. تحقق من وجود محتوى في قاعدة البيانات
4. راجع logs الخادم للأخطاء

## الخلاصة

تم تطوير نظام feed جديد ومحسّن يحل جميع المشاكل المذكورة:
- ✅ لا يوجد ارتباك في الواجهة الأمامية
- ✅ نسبة 15% فقط من منشورات المتابَعين
- ✅ دمج المنشورات والإعلانات
- ✅ خوارزمية ذكية مشابهة لفيسبوك
- ✅ دعم pagination
- ✅ أداء محسّن
