# إصلاح جذري لمشكلة فلترة المنشورات في الصفحة الرئيسية

## المشكلة الأساسية

كانت المنشورات والإعلانات من المتابعين تظهر **100%** في الصفحة الرئيسية بدلاً من **10-15%** فقط كما هو مطلوب.

## السبب الجذري

في الـ 3 endpoints لجلب المحتوى، كان المنطق خاطئاً:

### الكود القديم (الخاطئ):
```javascript
if (!notification || notification.showInFeed !== false) {
    filteredPosts.push(post);
}
```

**المشكلة:** هذا الشرط يعني:
- ✅ إذا **لم يوجد** إشعار → يعرض المنشور (خطأ!)
- ✅ إذا وُجد إشعار و `showInFeed !== false` → يعرض المنشور

**النتيجة:** جميع المنشورات من المتابعين كانت تظهر لأن معظمها لا يوجد لها إشعار بعد!

### الكود الجديد (الصحيح):
```javascript
if (notification && notification.showInFeed === true) {
    filteredPosts.push(post);
}
```

**الحل:** الآن الشرط صارم:
- ❌ إذا **لم يوجد** إشعار → **لا** يعرض المنشور
- ✅ إذا وُجد إشعار و `showInFeed === true` → يعرض المنشور فقط

**النتيجة:** فقط 15% من المنشورات التي لها إشعار بـ `showInFeed: true` ستظهر في الصفحة الرئيسية.

## الملفات المعدلة

### 1. `routes/postRoutes.js` (السطر 120-123)
```javascript
// نعرض المنشور فقط إذا وُجد إشعار وكان showInFeed = true
if (notification && notification.showInFeed === true) {
  filteredPosts.push(post);
}
```

### 2. `routes/shipmentAdRoutes.js` (السطر 116-119)
```javascript
// نعرض الإعلان فقط إذا وُجد إشعار وكان showInFeed = true
if (notification && notification.showInFeed === true) {
  filteredAds.push(ad);
}
```

### 3. `routes/emptyTruckAdRoutes.js` (السطر 102-105)
```javascript
// نعرض الإعلان فقط إذا وُجد إشعار وكان showInFeed = true
if (notification && notification.showInFeed === true) {
  filteredAds.push(ad);
}
```

## آلية العمل الكاملة

### عند نشر محتوى جديد:

1. **المستخدم ينشر منشور/إعلان**
2. **الباك إند يستدعي** `createFollowingPostNotifications(userId, contentId, type, 0.15)`
3. **النظام يختار عشوائياً 15% من المتابعين**
4. **يُنشئ إشعارات:**
   - 15% → `showInFeed: true` (يظهر في الصفحة الرئيسية + الإشعارات)
   - 85% → `showInFeed: false` (يظهر في الإشعارات فقط)

### عند جلب المحتوى للصفحة الرئيسية:

1. **المستخدم يفتح الصفحة الرئيسية**
2. **الباك إند يجلب جميع المنشورات/الإعلانات**
3. **يفلتر المحتوى:**
   - من **غير المتابعين** → يعرض دائماً ✅
   - من **المتابعين** → يتحقق من الإشعار:
     - ✅ إشعار موجود و `showInFeed === true` → يعرض
     - ❌ إشعار غير موجود أو `showInFeed === false` → **لا يعرض**
4. **يطبق خوارزمية الترتيب** (Facebook-style)
5. **يرسل النتيجة للمستخدم**

## النتيجة النهائية

بعد هذا الإصلاح:
- ✅ **15%** فقط من منشورات المتابعين تظهر في الصفحة الرئيسية
- ✅ **85%** الباقية تظهر في صفحة الإشعارات فقط
- ✅ **100%** من محتوى غير المتابعين يظهر دائماً
- ✅ النظام يعمل مثل فيسبوك تماماً

## اختبار الحل

### خطوات الاختبار:

1. **حساب A** يتابع **حساب B**
2. **حساب B** ينشر 10 منشورات
3. **حساب A** يفتح الصفحة الرئيسية
4. **النتيجة المتوقعة:** يرى فقط 1-2 منشور (10-20%)
5. **حساب A** يفتح صفحة الإشعارات
6. **النتيجة المتوقعة:** يرى جميع المنشورات الـ 10

## التاريخ

**2025-10-31**: إصلاح جذري لمنطق الفلترة في جميع endpoints جلب المحتوى
