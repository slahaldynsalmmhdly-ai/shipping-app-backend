# تحديث ميزة الهاشتاق والإشارة إلى الأشخاص

## نظرة عامة
تم تحديث الخادم الخلفي لإضافة دعم كامل لميزة الهاشتاقات (#hashtags) والإشارة إلى الأشخاص (@mentions) في جميع أنواع المحتوى (المنشورات، إعلانات الشحن، إعلانات الشاحنات الفارغة).

## التغييرات في قاعدة البيانات

### 1. تحديث النماذج (Models)
تم إضافة حقلين جديدين لجميع نماذج المحتوى:

#### Post.js, ShipmentAd.js, EmptyTruckAd.js
```javascript
hashtags: [{
  type: String,
  lowercase: true,
  trim: true
}],
mentions: [{
  type: mongoose.Schema.Types.ObjectId,
  ref: 'User'
}]
```

### 2. تحديث نموذج User
تم إضافة نوع إشعار جديد:
```javascript
enum: ["like", "new_post", "new_following_post", "new_following_shipment_ad", 
       "new_following_empty_truck_ad", "comment", "reply", "comment_like", 
       "reply_like", "new_message", "new_call", "mention"]
```

## نقاط النهاية الجديدة (API Endpoints)

### 1. الهاشتاقات (Hashtags)

#### البحث في الهاشتاقات (Autocomplete)
```
GET /api/v1/hashtags/search?q=searchTerm
```
**الوصف:** البحث عن هاشتاقات تبدأ بالنص المدخل (للإكمال التلقائي)
**الاستجابة:**
```json
[
  { "tag": "شحن", "count": 45 },
  { "tag": "شحن_سريع", "count": 23 }
]
```

#### الهاشتاقات الرائجة (Trending)
```
GET /api/v1/hashtags/trending?limit=20
```
**الوصف:** الحصول على الهاشتاقات الأكثر استخداماً وتفاعلاً في آخر 7 أيام
**الاستجابة:**
```json
[
  {
    "tag": "شحن",
    "count": 45,
    "engagement": 230,
    "score": 160
  }
]
```

#### المحتوى حسب الهاشتاق
```
GET /api/v1/hashtags/:hashtag/posts?page=1&limit=20
```
**الوصف:** الحصول على جميع المحتويات التي تحتوي على هاشتاق معين
**الاستجابة:**
```json
{
  "hashtag": "شحن",
  "content": [
    {
      "_id": "...",
      "contentType": "post",
      "user": {...},
      "text": "...",
      "hashtags": ["شحن", "نقل"],
      "mentions": [...]
    }
  ],
  "page": 1,
  "limit": 20,
  "hasMore": true
}
```

### 2. الإشارات (Mentions)

#### البحث عن المستخدمين (Autocomplete)
```
GET /api/v1/mentions/search?q=searchTerm
```
**الوصف:** البحث عن مستخدمين للإشارة إليهم (يدعم البحث في الأسماء وأسماء الشركات)
**الاستجابة:**
```json
[
  {
    "_id": "507f1f77bcf86cd799439011",
    "name": "شركة النقل السريع",
    "avatar": "...",
    "userType": "company"
  }
]
```

#### المحتوى الذي تم الإشارة فيه للمستخدم
```
GET /api/v1/mentions/me?page=1&limit=20
```
**الوصف:** الحصول على جميع المحتويات التي تم الإشارة فيها للمستخدم الحالي
**الاستجابة:**
```json
{
  "mentions": [
    {
      "_id": "...",
      "contentType": "post",
      "user": {...},
      "mentions": [...],
      "hashtags": [...]
    }
  ],
  "page": 1,
  "limit": 20,
  "hasMore": false
}
```

## التحديثات في المسارات الموجودة

### 1. إنشاء المحتوى
تم تحديث جميع نقاط النهاية لإنشاء المحتوى لدعم الهاشتاقات والإشارات:

#### POST /api/v1/posts
#### POST /api/v1/shipmentads
#### POST /api/v1/emptytruckads

**الطلب (Request Body):**
```json
{
  "text": "نبحث عن شاحنة للنقل #شحن #نقل_سريع @507f1f77bcf86cd799439011",
  "media": [...],
  "hashtags": ["شحن", "نقل_سريع"],
  "mentions": ["507f1f77bcf86cd799439011"],
  "scheduledTime": null
}
```

**ملاحظات:**
- يتم استخراج الهاشتاقات والإشارات تلقائياً من النص
- يمكن إرسال الهاشتاقات والإشارات بشكل منفصل في الحقول `hashtags` و `mentions`
- يتم دمج الهاشتاقات والإشارات المستخرجة مع تلك المرسلة صراحة
- يتم إرسال إشعارات تلقائية للمستخدمين المشار إليهم

## الملفات المساعدة الجديدة

### 1. utils/textParser.js
يحتوي على دوال لاستخراج ومعالجة الهاشتاقات والإشارات:
- `extractHashtags(text)` - استخراج الهاشتاقات من النص
- `extractMentionIds(text)` - استخراج معرفات المستخدمين المشار إليهم
- `formatTextWithLinks(text, mentions)` - تنسيق النص مع روابط الهاشتاقات والإشارات
- `isValidHashtag(hashtag)` - التحقق من صحة الهاشتاق

### 2. utils/mentionNotificationHelper.js
يحتوي على دالة لإرسال إشعارات للمستخدمين المشار إليهم:
- `createMentionNotifications(senderId, mentionIds, contentId, contentType)`

## الإشعارات

### إشعار الإشارة
عند الإشارة إلى مستخدم في أي محتوى، يتلقى المستخدم إشعاراً من نوع `mention` يحتوي على:
- معرف المرسل (sender)
- معرف المحتوى (post/shipmentAd/emptyTruckAd)
- نوع المحتوى (itemType)

## كيفية الاستخدام في الواجهة الأمامية

### 1. عند كتابة المحتوى:
- اكتشف عندما يكتب المستخدم `#` واعرض قائمة الهاشتاقات المقترحة من `/api/v1/hashtags/search`
- اكتشف عندما يكتب المستخدم `@` واعرض قائمة المستخدمين من `/api/v1/mentions/search`

### 2. عند عرض المحتوى:
- اعرض الهاشتاقات كروابط قابلة للنقر تؤدي إلى `/hashtag/:hashtag`
- اعرض الإشارات كروابط قابلة للنقر تؤدي إلى `/profile/:userId`

### 3. صفحات جديدة:
- صفحة الهاشتاق: `/hashtag/:hashtag` - تعرض جميع المحتويات بهذا الهاشتاق
- صفحة الإشارات: `/mentions` - تعرض جميع المحتويات التي تم الإشارة فيها للمستخدم

## ملاحظات مهمة

1. **الهاشتاقات:**
   - يتم تحويلها تلقائياً إلى أحرف صغيرة
   - تدعم العربية والإنجليزية والأرقام والشرطة السفلية
   - الحد الأقصى للطول: 50 حرف

2. **الإشارات:**
   - يجب أن تكون معرفات MongoDB صحيحة (24 حرف hex)
   - لا يمكن للمستخدم الإشارة لنفسه
   - يتم إرسال إشعار فوري للمستخدم المشار إليه

3. **الأداء:**
   - يتم استخدام الفهرسة (indexing) على حقول الهاشتاقات والإشارات
   - البحث يدعم التعبيرات النمطية (regex) للإكمال التلقائي
   - الهاشتاقات الرائجة تحسب بناءً على الاستخدام والتفاعل

## الخطوات التالية للواجهة الأمامية

1. إضافة مكون Autocomplete للهاشتاقات والإشارات في حقل النص
2. إضافة معالج للنص لتحويل الهاشتاقات والإشارات إلى روابط
3. إنشاء صفحة عرض المحتوى حسب الهاشتاق
4. إنشاء صفحة عرض الإشارات للمستخدم
5. إضافة قسم الهاشتاقات الرائجة في الصفحة الرئيسية أو الشريط الجانبي
6. تحديث معالج الإشعارات لدعم إشعارات الإشارة
