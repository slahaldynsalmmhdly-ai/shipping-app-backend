# إصلاح مشكلة عدم ظهور المنشورات في صفحات الحراج والوظائف

## المشكلة
عند نشر منشور في صفحات الحراج أو الوظائف، كان المنشور لا يظهر للمستخدم:
- لا يظهر في الصفحة الرئيسية
- لا يظهر في صفحة التصنيف المختارة
- لا يظهر عالمياً ولا في الفلترة المحلية

## السبب الجذري

### المشكلة الرئيسية: فلترة الموقع غير صحيحة

في ملف `routes/postRoutes.js` (السطور 146-152)، كان الكود القديم:

```javascript
// فلترة حسب الموقع (فقط إذا لم يكن 'عالمي')
if (country && country !== 'عالمي') {
  query.country = country;
  if (city) {
    query.city = city;
  }
}
```

**المشكلة:**
1. عندما ينشر المستخدم منشوراً عالمياً (`scope: 'global'`)، يتم حفظه بـ:
   - `scope: 'global'`
   - `country: null`
   - `city: null`

2. عندما يطلب المستخدم المنشورات من صفحة التصنيف (مثل "سيارات" أو "كهربائي")، يرسل:
   - `category: "سيارات"`
   - `country: "السعودية"` (من موقعه الحالي)
   - `city: "الرياض"` (من موقعه الحالي)

3. الاستعلام القديم كان يبحث عن:
   ```javascript
   { category: "سيارات", country: "السعودية" }
   ```

4. لكن المنشور العالمي محفوظ بـ:
   ```javascript
   { category: "سيارات", country: null }
   ```

5. **النتيجة:** المنشور لا يظهر في النتائج! ❌

### مشاكل إضافية:
- عدم التمييز الصحيح بين `scope: 'global'` و `scope: 'local'`
- المنشورات المحلية قد تظهر لمستخدمين من دول أخرى
- المنشورات العالمية لا تظهر عند تحديد موقع

## الحل

### التعديلات في `routes/postRoutes.js`

تم استبدال الكود القديم بمنطق جديد يعالج المشكلة:

```javascript
// فلترة حسب الموقع والنطاق (scope)
if (country && country !== 'عالمي') {
  // عرض المنشورات العالمية + المنشورات المحلية في نفس الدولة
  const locationConditions = [
    { scope: 'global' }, // المنشورات العالمية تظهر للجميع
    { scope: 'local', country: country } // المنشورات المحلية في نفس الدولة
  ];
  
  // إذا كانت المدينة محددة، نضيف شرط للمنشورات في نفس المدينة
  if (city) {
    locationConditions.push(
      { scope: 'local', country: country, city: city }
    );
    // إزالة الشرط العام للدولة فقط واستبداله بشروط أكثر دقة
    locationConditions[1] = { scope: 'local', country: country, $or: [{ city: city }, { city: null }, { city: { $exists: false } }] };
  }
  
  // دمج شروط الموقع مع الشروط الموجودة
  if (query.$or) {
    // إذا كان هناك $or موجود مسبقاً، نحتاج لدمجه
    const existingOr = query.$or;
    delete query.$or;
    query.$and = [
      { $or: existingOr },
      { $or: locationConditions }
    ];
  } else {
    query.$or = locationConditions;
  }
} else {
  // إذا لم يحدد المستخدم موقعاً أو اختار 'عالمي'، نعرض فقط المنشورات العالمية
  query.scope = 'global';
}
```

## كيف يعمل الحل الجديد

### السيناريو 1: المستخدم في السعودية - الرياض

**الطلب:**
```javascript
GET /api/v1/posts?category=سيارات&country=السعودية&city=الرياض
```

**الاستعلام المُنشأ:**
```javascript
{
  category: "سيارات",
  $or: [
    { scope: 'global' }, // ✅ المنشورات العالمية
    { 
      scope: 'local', 
      country: 'السعودية',
      $or: [
        { city: 'الرياض' }, // ✅ منشورات الرياض
        { city: null },      // ✅ منشورات السعودية بدون مدينة
        { city: { $exists: false } }
      ]
    }
  ]
}
```

**النتائج:**
- ✅ جميع المنشورات العالمية في فئة "سيارات"
- ✅ المنشورات المحلية في السعودية - الرياض
- ✅ المنشورات المحلية في السعودية بدون مدينة محددة
- ❌ المنشورات المحلية في دول أخرى

### السيناريو 2: المستخدم اختار "عالمي"

**الطلب:**
```javascript
GET /api/v1/posts?category=سيارات&country=عالمي
```

**الاستعلام المُنشأ:**
```javascript
{
  category: "سيارات",
  scope: 'global'
}
```

**النتائج:**
- ✅ فقط المنشورات العالمية في فئة "سيارات"
- ❌ المنشورات المحلية (لأي دولة)

### السيناريو 3: المستخدم لم يحدد موقعاً

**الطلب:**
```javascript
GET /api/v1/posts?category=سيارات
```

**الاستعلام المُنشأ:**
```javascript
{
  category: "سيارات",
  scope: 'global'
}
```

**النتائج:**
- ✅ فقط المنشورات العالمية في فئة "سيارات"

## التأثير

### قبل الإصلاح ❌
- المنشورات العالمية لا تظهر في صفحات التصنيف عند تحديد موقع
- المستخدمون لا يرون منشوراتهم بعد النشر
- تجربة مستخدم سيئة جداً

### بعد الإصلاح ✅
- المنشورات العالمية تظهر للجميع في كل الصفحات
- المنشورات المحلية تظهر فقط للمستخدمين في نفس الدولة/المدينة
- المستخدمون يرون منشوراتهم بعد النشر مباشرة
- فلترة دقيقة وصحيحة حسب الموقع

## الملفات المعدلة

1. `routes/postRoutes.js` - إصلاح فلترة الموقع والنطاق (السطور 146-178)

## الاختبار

### اختبار 1: نشر منشور عالمي في "سيارات"
1. إنشاء منشور جديد
2. اختيار فئة "سيارات"
3. اختيار نطاق "عالمي"
4. النشر
5. ✅ يجب أن يظهر في صفحة "سيارات" لجميع المستخدمين

### اختبار 2: نشر منشور محلي في "كهربائي"
1. إنشاء منشور جديد
2. اختيار فئة "كهربائي"
3. اختيار نطاق "محلي" - السعودية - الرياض
4. النشر
5. ✅ يجب أن يظهر فقط للمستخدمين في السعودية
6. ✅ يجب أن يظهر بشكل خاص للمستخدمين في الرياض

### اختبار 3: فلترة حسب الموقع
1. فتح صفحة "سيارات"
2. اختيار "السعودية" من الفلتر
3. ✅ يجب أن تظهر المنشورات العالمية + المنشورات المحلية في السعودية
4. اختيار "عالمي" من الفلتر
5. ✅ يجب أن تظهر فقط المنشورات العالمية

## ملاحظات

- هذا الإصلاح لا يؤثر على الواجهة الأمامية
- لا حاجة لتحديث قاعدة البيانات
- متوافق مع جميع المنشورات الموجودة
- يحسن الأداء من خلال استعلامات أكثر دقة

## التاريخ
- **تاريخ الإصلاح:** 20 نوفمبر 2025
- **المطور:** Manus AI
- **رقم الإصدار:** 1.0.0
